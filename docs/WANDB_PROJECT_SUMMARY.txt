================================================================================
WandBç›‘æ§ç³»ç»Ÿ - é¡¹ç›®äº¤ä»˜æ€»ç»“
================================================================================

ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•
================================================================================

æ–‡æ¡£ (docs/):
  1. WANDB_README.md                 (14KB) â­ é¡¹ç›®æ€»è§ˆå’Œå¿«é€Ÿç´¢å¼•
  2. WANDB_QUICKSTART.md             (11KB) ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å— (æ¨èç¬¬ä¸€ä¸ªé˜…è¯»)
  3. WANDB_MONITORING_DESIGN.md      (19KB) ğŸ“Š è¯¦ç»†è®¾è®¡æ–‡æ¡£ (ç³»ç»Ÿåˆ†æ+æ–¹æ¡ˆè®¾è®¡)
  4. WANDB_PATCH_GUIDE.md            (5KB)  ğŸ”§ æ‰‹åŠ¨è¡¥ä¸åº”ç”¨æŒ‡å— (10ä¸ªè¡¥ä¸è¯¦ç»†æ­¥éª¤)

ä»£ç  (src/):
  5. wandb_metrics_collectors.py     (16KB) ğŸ’ å¯å¤ç”¨çš„æŒ‡æ ‡æ”¶é›†å·¥å…·ç±»
     - DatasetMetricsCollector       (æ•°æ®é›†ç»´åº¦ç»Ÿè®¡)
     - JudgeMetricsCollector         (LLM Judgeæ€§èƒ½ç›‘æ§)
     - CostTracker                   (æˆæœ¬è¿½è¸ª)

è„šæœ¬ (scripts/):
  6. apply_wandb_patch.py            (13KB) ğŸ¤– åŠè‡ªåŠ¨è¡¥ä¸åº”ç”¨å·¥å…·

================================================================================
æ ¸å¿ƒåŠŸèƒ½
================================================================================

âœ… æ•°æ®é›†ç»´åº¦ç›‘æ§ (P0)
   - ä¸ºæ¯ä¸ªæ•°æ®é›†(GSM8K, MATH, HotpotQAç­‰)å•ç‹¬ç»Ÿè®¡å‡†ç¡®ç‡
   - è®­ç»ƒé›†å’ŒéªŒè¯é›†å‡æ”¯æŒ
   - WandBæŒ‡æ ‡: dataset/{source}/accuracy, count, avg_reward

âœ… LLM Judgeæ€§èƒ½ç›‘æ§ (P1)
   - æˆåŠŸç‡ã€è§£æå¤±è´¥ç‡ã€APIå¤±è´¥ç‡ç»Ÿè®¡
   - åˆ¤å†³åˆ†å¸ƒåˆ†æ (æ­£ç¡®/é”™è¯¯æ¯”ä¾‹)
   - WandBæŒ‡æ ‡: judge/success_rate, parse_failure_rate, correct_ratio

âœ… éªŒè¯é›†è¯¦ç»†åˆ†æ (P1)
   - æŒ‰æ•°æ®é›†åˆ†è§£çš„éªŒè¯é›†æ€§èƒ½
   - æˆæœ¬vså‡†ç¡®ç‡å…³è”åˆ†æ
   - WandBæŒ‡æ ‡: val/{source}/accuracy, count, avg_cost

âœ… æˆæœ¬ç»Ÿè®¡ (P2)
   - ç´¯ç§¯æˆæœ¬è¿½è¸ª
   - å¹³å‡æˆæœ¬peræ ·æœ¬
   - Executor/Judgeè°ƒç”¨è®¡æ•°
   - WandBæŒ‡æ ‡: cost/total_cost, avg_cost_per_sample

================================================================================
å¿«é€Ÿå¼€å§‹ (3æ­¥)
================================================================================

Step 1: æµ‹è¯•å·¥å…·ç±»
  $ cd /home/yijia/.claude/11/integrated_aflow_roll
  $ python3 src/wandb_metrics_collectors.py
  
  é¢„æœŸè¾“å‡º:
    ğŸ§ª æµ‹è¯•DatasetMetricsCollector
    WandBæ—¥å¿—:
      dataset/gsm8k/accuracy: 66.7
    âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼

Step 2: åº”ç”¨è¡¥ä¸åˆ°grpo_trainer.py
  $ cp src/grpo_trainer.py src/grpo_trainer.py.backup
  $ cat docs/WANDB_PATCH_GUIDE.md  # æŸ¥çœ‹10ä¸ªè¡¥ä¸çš„è¯¦ç»†æ­¥éª¤
  $ vim src/grpo_trainer.py         # æ‰‹åŠ¨åº”ç”¨è¡¥ä¸
  
  æˆ–ä½¿ç”¨åŠè‡ªåŠ¨å·¥å…·:
  $ python3 scripts/apply_wandb_patch.py

Step 3: éªŒè¯å’Œè¿è¡Œ
  $ python3 -m py_compile src/grpo_trainer.py
  $ python3 -c "from src.grpo_trainer import GRPOTrainer; print('âœ… OK')"
  $ python3 train.py  # ä¿®æ”¹config/training.yaml: wandb.mode=offline
  
  æ£€æŸ¥è¾“å‡ºä¸­çš„æ–°ç»Ÿè®¡:
    ğŸ“Š æ•°æ®é›†ç»Ÿè®¡æ‘˜è¦:
      gsm8k          :   2/  3 =  66.7%
      math           :   1/  2 =  50.0%
    ğŸ¤– LLM Judgeç»Ÿè®¡ (æ€»è®¡: 100 æ¬¡):
      æˆåŠŸ: 85 (85.0%)
    ğŸ’° æˆæœ¬ç»Ÿè®¡:
      æ€»æˆæœ¬: $0.0350

================================================================================
ç³»ç»Ÿç ”ç©¶æˆæœ
================================================================================

1. è®­ç»ƒæ¶æ„åˆ†æ:
   - ä¸»è®­ç»ƒå¾ªç¯: train() â†’ train_step() â†’ evaluate_on_val_set()
   - æ•°æ®é‡‡æ ·: æ”¯æŒæ··åˆæ•°æ®é›†é‡‡æ · (domain_ratios)
   - GRPOç®—æ³•: æ¯ä¸ªé—®é¢˜ç”ŸæˆKä¸ªå·¥ä½œæµï¼Œç»„å†…å½’ä¸€åŒ–
   - å¥–åŠ±ç³»ç»Ÿ: äºŒå…ƒå¥–åŠ± (æ­£ç¡®=1.0, é”™è¯¯=0.0)

2. æ•°æ®é›†æ”¯æŒ:
   - âœ… GSM8K (math, source="gsm8k")
   - âœ… MATH (math, source="math")
   - âœ… HotpotQA (qa, source="hotpotqa")
   - âœ… HumanEval (code, source="humaneval")
   - âœ… CommonsenseQA (qa, source="commonsenseqa")
   - âœ… MMLU (qa, source="mmlu")

3. è¯„ä¼°ç³»ç»Ÿ:
   - RewardComputer: ç»Ÿä¸€çš„å¥–åŠ±è®¡ç®—æ¥å£
   - LLM Judge: GPT OSS 120B @ port 8002
   - æ•°æ®é›†ä¸“å±Prompt: JudgePromptLoaderæ”¯æŒ
   - ç»Ÿè®¡è·Ÿè¸ª: eval_statså­—å…¸è®°å½•Judgeæ€§èƒ½

4. å…³é”®å‘ç°:
   - æ¯ä¸ªæ ·æœ¬æœ‰sourceå­—æ®µæ ‡è¯†æ•°æ®é›†
   - LLM Judgeä½¿ç”¨æ•°æ®é›†ä¸“å±çš„è¯„ä¼°ç­–ç•¥
   - å½“å‰ç¼ºå°‘æ•°æ®é›†çº§åˆ«çš„æ€§èƒ½ç›‘æ§
   - éœ€è¦æˆæœ¬è¿½è¸ªç”¨äºä¼˜åŒ–

================================================================================
å®ç°ç»†èŠ‚
================================================================================

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶: src/grpo_trainer.py

è¡¥ä¸æ¸…å• (å…±10ä¸ª):
  âœ… Patch 1:  æ·»åŠ å¯¼å…¥è¯­å¥ (ç¬¬27è¡Œå)
  âœ… Patch 2:  åˆå§‹åŒ–æˆæœ¬è¿½è¸ªå™¨ (ç¬¬214è¡Œå)
  âœ… Patch 3:  train_stepåˆå§‹åŒ–æ”¶é›†å™¨ (ç¬¬294è¡Œå)
  âš ï¸  Patch 4:  è·å–sourceå­—æ®µ (ç¬¬316è¡Œ) - éœ€æ‰‹åŠ¨
  âš ï¸  Patch 5:  è®°å½•åˆ°æ”¶é›†å™¨ (ç¬¬393è¡Œå) - éœ€æ‰‹åŠ¨
  âœ… Patch 6:  æ·»åŠ wandbæ—¥å¿— (ç¬¬513è¡Œå‰)
  âš ï¸  Patch 7:  éªŒè¯é›†åˆå§‹åŒ– (ç¬¬674è¡Œå) - éœ€æ‰‹åŠ¨
  âš ï¸  Patch 8:  éªŒè¯é›†source (ç¬¬682è¡Œ) - éœ€æ‰‹åŠ¨
  âš ï¸  Patch 9:  éªŒè¯é›†è®°å½• (ç¬¬732è¡Œå) - éœ€æ‰‹åŠ¨
  âš ï¸  Patch 10: éªŒè¯é›†æ—¥å¿— (ç¬¬800è¡Œ) - éœ€æ‰‹åŠ¨

è‡ªåŠ¨åº”ç”¨: 4ä¸ª (Patch 1, 2, 3, 6)
æ‰‹åŠ¨åº”ç”¨: 6ä¸ª (Patch 4, 5, 7, 8, 9, 10)

è¯¦ç»†ä»£ç è§: docs/WANDB_PATCH_GUIDE.md

================================================================================
é¢„æœŸæ•ˆæœ
================================================================================

å®æ–½å‰:
  wandb.log({
      "train/accuracy": 65.0,        # æ€»ä½“å‡†ç¡®ç‡
      "train/accuracy_math": 70.0,   # é—®é¢˜ç±»å‹
  })
  âŒ æ— æ³•åŒºåˆ†GSM8Kå’ŒMATHçš„æ€§èƒ½
  âŒ æ— æ³•ç›‘æ§LLM Judgeè´¨é‡
  âŒ æ— æ³•è¿½è¸ªæˆæœ¬

å®æ–½å:
  wandb.log({
      "train/accuracy": 65.0,
      "train/accuracy_math": 70.0,
      # ğŸ†• æ•°æ®é›†ç»´åº¦
      "dataset/gsm8k/accuracy": 85.2,
      "dataset/math/accuracy": 42.1,
      "dataset/hotpotqa/accuracy": 68.3,
      # ğŸ†• LLM Judge
      "judge/success_rate": 0.85,
      "judge/correct_ratio": 0.706,
      # ğŸ†• æˆæœ¬
      "cost/total_cost": 12.34,
      "cost/avg_cost_per_sample": 0.0123,
  })
  âœ… å®Œæ•´çš„æ•°æ®é›†çº§æ€§èƒ½å¯è§æ€§
  âœ… LLM Judgeè´¨é‡ç›‘æ§
  âœ… æˆæœ¬è¿½è¸ªå’Œä¼˜åŒ–ä¾æ®

================================================================================
ä½¿ç”¨åœºæ™¯ç¤ºä¾‹
================================================================================

åœºæ™¯1: è¯Šæ–­MATHæ€§èƒ½ä½ä¸‹
  import wandb
  api = wandb.Api()
  run = api.run("project/run_id")
  
  gsm8k = run.summary['dataset/gsm8k/accuracy']
  math = run.summary['dataset/math/accuracy']
  print(f"GSM8K: {gsm8k:.1f}%")  # 85.2%
  print(f"MATH: {math:.1f}%")    # 42.1%
  print(f"å·®è·: {gsm8k - math:.1f}pp")  # 43.1pp â†’ éœ€è¦é‡ç‚¹ä¼˜åŒ–!

åœºæ™¯2: ç›‘æ§LLM Judgeå¥åº·åº¦
  judge_success = run.summary['judge/success_rate']
  if judge_success < 0.8:
      print("âš ï¸  JudgeæˆåŠŸç‡è¿‡ä½!")
      print("æ£€æŸ¥: GPT OSS 120BæœåŠ¡ (port 8002)")

åœºæ™¯3: æˆæœ¬ä¼˜åŒ–åˆ†æ
  history = run.history(keys=['cost/avg_cost_per_sample', 'train/accuracy'])
  df['efficiency'] = df['cost'] / (df['accuracy'] / 100)
  best = df.loc[df['efficiency'].idxmin()]
  print(f"æœ€é«˜æ•ˆstep: {best['train/step']:.0f}")

================================================================================
æ–‡æ¡£å¯¼èˆª
================================================================================

ğŸ“š é˜…è¯»é¡ºåº (æ–°æ‰‹):
  1. docs/WANDB_README.md            - é¡¹ç›®æ€»è§ˆ (5åˆ†é’Ÿ)
  2. docs/WANDB_QUICKSTART.md        - å¿«é€Ÿå¼€å§‹ (10åˆ†é’Ÿ)
  3. docs/WANDB_PATCH_GUIDE.md       - åº”ç”¨è¡¥ä¸ (20åˆ†é’Ÿ)
  4. src/wandb_metrics_collectors.py - ç†è§£ä»£ç  (15åˆ†é’Ÿ)

ğŸ“š æ·±å…¥é˜…è¯» (é«˜çº§):
  1. docs/WANDB_MONITORING_DESIGN.md - è¯¦ç»†è®¾è®¡ (30åˆ†é’Ÿ)
     - ç³»ç»Ÿæ¶æ„åˆ†æ
     - æŒ‡æ ‡è®¾è®¡è¯¦è§£
     - WandBä»ªè¡¨æ¿é…ç½®
     - æ€§èƒ½å¼€é”€è¯„ä¼°

ğŸ”§ å·¥å…·ä½¿ç”¨:
  - æµ‹è¯•å·¥å…·: python3 src/wandb_metrics_collectors.py
  - åº”ç”¨è¡¥ä¸: python3 scripts/apply_wandb_patch.py
  - éªŒè¯è¯­æ³•: python3 -m py_compile src/grpo_trainer.py

================================================================================
éªŒè¯æ¸…å•
================================================================================

â–¡ Step 1: å·¥å…·ç±»æµ‹è¯•é€šè¿‡
  $ python3 src/wandb_metrics_collectors.py
  âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼

â–¡ Step 2: è¡¥ä¸åº”ç”¨å®Œæˆ
  $ cat docs/WANDB_PATCH_GUIDE.md  # æŸ¥çœ‹10ä¸ªè¡¥ä¸
  âœ… å·²åº”ç”¨æ‰€æœ‰è¡¥ä¸

â–¡ Step 3: è¯­æ³•éªŒè¯é€šè¿‡
  $ python3 -m py_compile src/grpo_trainer.py
  âœ… æ— è¯­æ³•é”™è¯¯

â–¡ Step 4: å¯¼å…¥æµ‹è¯•é€šè¿‡
  $ python3 -c "from src.grpo_trainer import GRPOTrainer"
  âœ… å¯¼å…¥æˆåŠŸ

â–¡ Step 5: ç¦»çº¿è®­ç»ƒæµ‹è¯•
  $ python3 train.py  # wandb.mode=offline
  âœ… å¯è§æ•°æ®é›†ç»Ÿè®¡æ‘˜è¦
  âœ… å¯è§LLM Judgeç»Ÿè®¡
  âœ… å¯è§æˆæœ¬ç»Ÿè®¡

â–¡ Step 6: WandBæ—¥å¿—éªŒè¯
  $ ls wandb/offline-run-*
  âœ… ç¦»çº¿æ—¥å¿—å·²ç”Ÿæˆ
  âœ… åŒ…å«æ•°æ®é›†ç»´åº¦æŒ‡æ ‡
  âœ… åŒ…å«JudgeæŒ‡æ ‡
  âœ… åŒ…å«æˆæœ¬æŒ‡æ ‡

â–¡ Step 7: åœ¨çº¿åŒæ­¥æµ‹è¯•
  $ wandb sync wandb/offline-run-*
  âœ… æ—¥å¿—åŒæ­¥æˆåŠŸ
  âœ… WandBä»ªè¡¨æ¿å¯è§†åŒ–æ­£å¸¸

================================================================================
æ•…éšœæ’æŸ¥
================================================================================

é—®é¢˜1: ImportError: cannot import name 'DatasetMetricsCollector'
  â†’ æ£€æŸ¥: ls src/wandb_metrics_collectors.py
  â†’ è§£å†³: export PYTHONPATH="$PWD:$PYTHONPATH"

é—®é¢˜2: æ•°æ®é›†ç»Ÿè®¡ä¸ºç©º
  â†’ æ£€æŸ¥: head data/mixed/*.jsonl | jq .source
  â†’ è§£å†³: ç¡®è®¤æ•°æ®åŒ…å«sourceå­—æ®µ

é—®é¢˜3: LLM Judgeç»Ÿè®¡ä¸æ›´æ–°
  â†’ æ£€æŸ¥: grep "use_llm_judge" src/grpo_trainer.py
  â†’ è§£å†³: ç¡®ä¿use_llm_judge=True

é—®é¢˜4: WandBç¦»çº¿æ—¥å¿—æœªç”Ÿæˆ
  â†’ æ£€æŸ¥: grep "mode:" config/training.yaml
  â†’ è§£å†³: è®¾ç½®wandb.mode=offline

================================================================================
æ€§èƒ½å¼€é”€è¯„ä¼°
================================================================================

è®¡ç®—å¼€é”€:  < 1% (ä»…ç»Ÿè®¡æ“ä½œ)
WandBä¸Šä¼ : ~ 2-3 KB/step (æ–°å¢æŒ‡æ ‡)
å†…å­˜å¼€é”€:  < 10 MB (ä¸´æ—¶ç»Ÿè®¡å­—å…¸)

ç»“è®º: å¼€é”€å¯å¿½ç•¥ä¸è®¡

================================================================================
é¡¹ç›®çŠ¶æ€
================================================================================

çŠ¶æ€: âœ… å·²å®Œæˆ
äº¤ä»˜æ—¶é—´: 2025-11-23 17:05 CST
ç»´æŠ¤è€…: AI Training Team

æ–‡æ¡£æ€»è®¡: 4ä¸ª (49KB)
ä»£ç æ€»è®¡: 2ä¸ª (29KB)

ä¸‹ä¸€æ­¥:
  1. åº”ç”¨è¡¥ä¸åˆ°grpo_trainer.py
  2. è¿è¡Œç¦»çº¿æµ‹è¯•éªŒè¯
  3. é…ç½®WandBä»ªè¡¨æ¿
  4. æ ¹æ®ç›‘æ§ç»“æœä¼˜åŒ–è®­ç»ƒ

================================================================================
